name: HLS

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  hls-test-suite:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: '0'

    # --------
    # Compile jlm with the HLS backend enabled
    # --------

    - name: "Build CIRCT"
      uses: ./.github/actions/BuildCirct
    - name: "Configure jlm"
      run: ./configure.sh --enable-asserts --enable-hls ${{ github.workspace }}/build-circt/circt CXX=clang++-16
    - name: "Compile jlm"
      run: make -j `nproc` -O

    # --------
    # Run HLS test suite
    # --------

    - name: "Install verilator"
      run: sudo apt-get install verilator
    - name: "Clone jlm-test-suite"
      run: git clone https://github.com/phate/jlm-eval-suite.git
    - name: "Link the build output directory to where it is expected by jlm-eval-suite"
      run: ln -s ${{ github.workspace }}/build jlm-eval-suite/jlm/build
    - name: "Run hls-test-suite"
      run: |
        cd jlm-eval-suite
        make hls-test-run
